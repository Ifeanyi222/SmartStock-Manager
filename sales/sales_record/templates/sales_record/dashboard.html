{% extends 'sales_record/base.html' %}
{% load static %}
{% block content %}

<div class="container mt-4">

  <!-- üß≠ Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold mb-0">üìä SmartStock Dashboard</h2>
    {% if role == 'manager' %}
    <div>
      <a href="{% url 'add_stock' %}" class="btn btn-primary btn-sm me-2">‚ûï Add Stock</a>
      <a href="{% url 'register' %}" class="btn btn-success btn-sm">üë• Register Staff</a>
    </div>
    {% endif %}
  </div>

  <!-- üîç Search -->
  <form id="search-form" method="get" action="" class="mb-4">
    <div class="input-group shadow-sm">
      <input
        type="text"
        id="search-input"
        name="q"
        class="form-control"
        placeholder="Search by brand, model, ref no, or supplier..."
        value="{{ query|default:'' }}"
      >
      <span class="input-group-text bg-light"><i class="bi bi-search"></i></span>
    </div>
  </form>

  <!-- ‚ö†Ô∏è Low Stock Alert -->
  {% if low_stock_products %}
  <div class="alert alert-danger border-danger shadow-sm">
    <h5 class="fw-bold mb-2">‚ö†Ô∏è Low Stock Alert</h5>
    <ul class="mb-0 ps-3">
      {% for product in low_stock_products %}
        <li>{{ product.brand }} ‚Äì {{ product.model_name }} ({{ product.quantity }} left)</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <div id="dashboard-tables">

    <!-- üì¶ Product Table -->
    <h4 class="fw-semibold mt-4 mb-3">üì¶ Available Products</h4>
    <div class="table-responsive shadow-sm rounded">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Brand</th>
            <th>Model</th>
            <th>Ref No</th>
            <th>Category</th>
            <th>Supplier</th>
            <th>Condition</th>
            <th>Qty</th>
            <th>Purchase Price (‚Ç¶)</th>
            <th>Selling Price (‚Ç¶)</th>
            <th>Remark</th>
            {% if role == 'manager' %}<th>Actions</th>{% endif %}
          </tr>
        </thead>
        <tbody>
          {% for p in products %}
          <tr>
            <td>{{ p.brand }}</td>
            <td>{{ p.model_name }}</td>
            <td>{{ p.ref_no }}</td>
            <td>{{ p.category|default:"‚Äî" }}</td>
            <td>{{ p.supplier|default:"‚Äî" }}</td>
            <td>
              {% if p.condition == 'new' %}
                <span class="badge bg-success">New</span>
              {% else %}
                <span class="badge bg-secondary">Used</span>
              {% endif %}
            </td>
            <td>
              {% if p.quantity <= 5 %}
                <span class="badge bg-danger">{{ p.quantity }}</span>
              {% else %}
                {{ p.quantity }}
              {% endif %}
            </td>
            <td>{{ p.purchase_price|floatformat:2|default:"‚Äî" }}</td>
            <td>‚Ç¶{{ p.selling_price|floatformat:2 }}</td>
            <td>{{ p.remark|default:"‚Äî" }}</td>
            {% if role == 'manager' %}
            <td>
              <a href="{% url 'edit_stock' p.id %}" class="btn btn-sm btn-outline-primary">‚úèÔ∏è</a>
              <a href="{% url 'delete_stock' p.id %}" class="btn btn-sm btn-outline-danger">üóëÔ∏è</a>
            </td>
            {% endif %}
          </tr>
          {% empty %}
          <tr>
            <td colspan="{% if role == 'manager' %}11{% else %}10{% endif %}" class="text-center text-muted py-3">
              No products found üòï
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- üí∞ Sales Section -->
    <h4 class="fw-semibold mt-5 mb-3">üí∞ Recent Sales</h4>
    <div class="table-responsive shadow-sm rounded">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th>Invoice #</th>
            <th>Customer</th>
            <th>Sold By</th>
            <th>Products</th>
            <th>Quantities</th>
            <th>Remarks</th>
            <th>Total (‚Ç¶)</th>
          </tr>
        </thead>
        <tbody>
          {% for sale in sales %}
          <tr>
            <td>{{ sale.date|date:"Y-m-d H:i" }}</td>
            <td>{{ sale.invoice_number|default:"‚Äî" }}</td>
            <td>{{ sale.customer_name|default:"‚Äî" }}</td>
            <td>{{ sale.user.username }}</td>
            <td>
              <ul class="mb-0 ps-3">
                {% for item in sale.items.all %}
                <li>{{ item.product.brand }} - {{ item.product.model_name }}</li>
                {% endfor %}
              </ul>
            </td>
            <td>
              <ul class="mb-0 ps-3">
                {% for item in sale.items.all %}
                <li>{{ item.quantity }}</li>
                {% endfor %}
              </ul>
            </td>
            <td>
              <ul class="mb-0 ps-3">
                {% for item in sale.items.all %}
                <li>{{ item.remark|default:"‚Äî" }}</li>
                {% endfor %}
              </ul>
            </td>
            <td><strong>‚Ç¶{{ sale.total_amount|floatformat:2 }}</strong></td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="text-center text-muted py-3">No sales recorded yet üìâ</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</div>

<!-- üß† AJAX Search Script -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const input = document.getElementById('search-input');
  const dashboard = document.getElementById('dashboard-tables');
  let timeout = null;

  input.addEventListener('input', () => {
    clearTimeout(timeout);
    timeout = setTimeout(() => {
      const query = input.value.trim();
      dashboard.innerHTML = "<div class='text-center py-4 text-muted'>‚è≥ Searching...</div>";

      fetch(`{% url 'search_dashboard' %}?q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
          dashboard.innerHTML = data.html;
        })
        .catch(() => {
          dashboard.innerHTML = "<div class='text-center text-danger py-4'>‚ùå Error loading search results.</div>";
        });
    }, 400);
  });
});
</script>

{% endblock %}
